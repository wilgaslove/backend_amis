const express = require('express');
const router = express.Router();
const { getAllReferents, getReferentsAvecMembres  } = require('../controllers/referentController');
const authMiddleware = require('../middlewares/authMiddleware');
const Referent = require('../models/Referent');
const User = require('../models/User');
const Membre = require('../models/Membre');
const { listerMembres } = require('../controllers/membreController');
const checkRole = require('../middlewares/checkRole');



// route pour r√©cup√©rer tous les referents. 
router.get('/referents', authMiddleware, getAllReferents);

// GET membres d‚Äôun r√©f√©rent
// router.get('/api/referents/:id/membres', referentController.getMembresDuReferent);
// router.get('/referents', authMiddleware, getAllReferents);



// ‚úÖ Tous les r√©f√©rents avec leurs User et leurs membres
router.get('/', async (req, res) => {
  try {
    const referents = await Referent.find()
      .populate('user', 'nom prenom userLogin role')   // Donn√©es utilisateur
      .populate('membres');                            // Membres li√©s
    res.json(referents);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: 'Erreur chargement des r√©f√©rents' });
  }
});


// üîê Toutes les routes ici n√©cessitent d'√™tre authentifi√©
router.use(authMiddleware);

// üßë‚Äçü§ù‚Äçüßë Route : GET /api/referents
// R√©cup√©rer tous les r√©f√©rents
router.get('/', async (req, res) => {
  try {
    const referents = await User.find({ role: 'referent' });
    res.json(referents);
  } catch (error) {
    console.error("Erreur lors de la r√©cup√©ration des r√©f√©rents :", error);
    res.status(500).json({ message: "Erreur serveur" });
  }
});


// R√©cup√©rer tous les r√©f√©rents avec leurs membres li√©s
router.get('/avec-membres', async (req, res) => {
  try {
    const referents = await User.find({ role: 'referent' }).lean();

    const referentsAvecMembres = await Promise.all(
      referents.map(async (referent) => {
        const membres = await User.find({ referent: referent._id });
        return {
          ...referent,
          membres,
        };
      })
    );

    res.json(referentsAvecMembres);
  } catch (error) {
    console.error("Erreur lors de la r√©cup√©ration des r√©f√©rents avec membres :", error);
    res.status(500).json({ message: "Erreur serveur" });
  }
});

// R√©cup√©rer les membres d'un r√©f√©rent sp√©cifique
// router.get('/:id/membres', async (req, res) => {
//   try {
//     const referentId = req.params.id;

//     const referent = await User.findById(referentId);
//     if (!referent || referent.role !== 'referent') {
//       return res.status(404).json({ message: 'R√©f√©rent non trouv√©' });
//     }

//     const membres = await User.find({ referent: referentId });
//     res.json(membres);
//   } catch (error) {
//     console.error("Erreur lors de la r√©cup√©ration des membres du r√©f√©rent :", error);
//     res.status(500).json({ message: "Erreur serveur" });
//   }
// });

// R√©cup√©rer tous les r√©f√©rents avec les membres li√©s

router.get('/referents-avec-membres', async (req, res) => {
  try {
    const referents = await Referent.find().populate('user');

    // Pour chaque r√©f√©rent, on r√©cup√®re dynamiquement les membres li√©s via referentId
    const referentsAvecMembres = await Promise.all(
      referents.map(async (referent) => {
        const membres = await Membre.find({ referentId: referent._id });
        return {
          ...referent.toObject(),
          membres
        };
      })
    );

    res.status(200).json(referentsAvecMembres);
  } catch (error) {
    console.error('Erreur lors de la r√©cup√©ration des r√©f√©rents avec membres :', error);
    res.status(500).json({ message: 'Erreur serveur', error });
  }
});

// Lister tous les membres (admin, leader uniquement)
router.get('/membres', authMiddleware, checkRole(['admin', 'leader']), listerMembres);


// Obtenir les membres li√©s √† un r√©f√©rent
router.get('/referents/:id/membres', async (req, res) => {
  try {
    const referentId = req.params.id;

    // Cherche les membres dont le champ referentId est √©gal √† l'ID donn√©
    const membres = await Membre.find({ referentId });

    res.json(membres);
  } catch (err) {
    console.error('Erreur serveur:', err);
    res.status(500).json({ message: 'Erreur serveur' });
  }
});

module.exports = router;


